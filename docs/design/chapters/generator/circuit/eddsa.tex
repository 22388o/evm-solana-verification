\subsection{Ed25519 Circuit}
\label{section:eddsa}

To verify a signature $(R,s)$ on a message $M$ using public key $A$ and a generator $B$ do:
\begin{enumerate}
    \item Prove that $s$ in the range $L = 2^{252}+27742317777372353535851937790883648493$.
        \begin{center}
    \begin{tabular}{ c|c|c|c|c|c|c|c|c|c }
        & $w_0$  & $w_1$  & $w_2$  & $w_3$  & $w_4$  & $w_5$ & $w_6$ & $w_7$ & $w_8$  \\
            \hline
                j + 0 & $s$ & $z_0$ & $z_1$ & $z_2$ & $z_3$ & $z_4$ & $z_5$ & $z_6$ & $z_7$ \\
                j + 1 & $z_8$ & $z_{9}$ & $z_{10}$ & $z_{11}$ & $z_{12}$ & $z_{13}$ & $z_{14}$ & $z_{15}$ & $z_{16}$ \\
                j + 2 & $z_{17}$ & $z_{18}$ & $z_{19}$ & $z_{20}$ & $z_{21}$ & $z_{22}$ & $z_{23}$ & $z_{24}$ & $z_{25}$ \\
            \end{tabular}
        \end{center}
        Evaluations:
        \begin{center}
        $z_0 = s + 2^{253} - L$ is decomposed into 10-bit windows $k_0 + 2^{10} \cdot k_1 + 2^{10 \cdot 2} \cdot k_2 + ... + 2^{10 \cdot 25} \cdot k_{25}$ \\
        $z_i = (z_{i - 1} - k_{i - 1}) / 2^{10}$
        \end{center}
        Constraints:
        \begin{center}
            $w_{1, j} = w_{0,j} + 2^{253} - L $ \\
            Each $w_{i,k} - 2^{10} \cdot w_{i + a, k + b} $, where $i = 1,..,8$ for $k = 0$, $i = 0,..,8$ for $k = 1$ and $i = 0,..,7$ for $k = 2$, $(i + 1) = b \cdot 9 + a$  is range-constrained by 10-bits plookup table. \\
            $w_{8,j+2} \cdot 2^7 $ is range-constrained by 10-bits plookup table.
        \end{center}
	It costs $3$ rows.
    \item $k == $ SHA-512$(data||R||A||M)$ // See section \ref{sha512}
     \begin{center}
    \begin{tabular}{ c|c|c|c|c|c|c|c|c|c }
    j + 0 & $k_0$  & $k_1$ & $k_2$ & $k_3$ & $k_4$ & $k_5$ & $--$ & $--$ & $--$   \\
    j + 1 & $k_6$  & $k_7$ & $k$ & $$ & $$ & $$ & $--$ & $--$ & $--$   \\
    \end{tabular}
\end{center}
	The tuple $\{k_0, k _1, ..., k_7 \}$ is copy-constrained with tuple $\{h_0, h_1, ..., h_7\}$ from HSA-512 circuit.
	The constraint $w_{3, j + 1} = w_{0, j + 0} \cdot 2^{7 \cdot 64} + w_{1, j + 0}\cdot 2^{6 \cdot 64}  + w_{2, j + 0}\cdot 2^{5 \cdot 64}  + w_{3, j + 0}\cdot 2^{4 \cdot 64}  + w_{4, j + 0}\cdot 2^{3 \cdot 64}  + w_{5, j + 0} \cdot 2^{2 \cdot 64}  + w_{0, j + 1} \cdot 2^{64} + w_{1, j + 1}$
    It costs $1248 \cdot 2 + 1 = 2497$ rows.
    \item $sB ?=? R + kA$:
        \begin{enumerate}
            \item Fixed-base scalar multiplication circuit is used for $sB = S$. The cell $w_{0, j + 84}$ is copy-constrained with $w_{0, j + 0}$ from the range circuit.
            \item One addition is used for $S + (-R)$. The coordinates of $R$ and $T = S + (-R)$ are placed on the last row of fixed-base scalar multiplication circuit.
                    \begin{center}
    \begin{tabular}{ c|c|c|c|c|c|c|c|c|c }
    j + 0 & $x_s$  & $x_r$ & $y_r$ & $x_t$ & $y_t$ & $y_s$ & $--$ & $--$ & $--$   \\
    \end{tabular}
\end{center}
                In total, three constraints are used for addition:
                \begin{center}
                    $w_{3, j + 0}\cdot (1 + d w_{0, j + 0} \cdot (-w_{1, j + 0}) \cdot w_{5, j + 0} \cdot w_{2, j + 0}) = w_{0, j + 0} \cdot w_{2, j + 0} + (-w_{1, j + 0}) \cdot w_{5, j + 0}$ \\
                    $w_{4, j + 0} \cdot (1 - d w_{0, j + 0} \cdot (-w_{1, j + 0}) \cdot w_{5, j + 0} \cdot w_{2, j + 0}) = w_{0, j + 0} \cdot (-w_{1, j + 0}) + w_{2, j + 0} \cdot w_{5, j + 0}$ \\
                    $(- w_{1, j + 0})^2 + w_{2, j + 0}^2 = 1 - d \cdot w_{1, j + 0}^2 \cdot w_{2, j + 0}^2$
                    $w_{1, j + 0}, w_{5, j + 0}$ are copy-constrained with $w_{6, j + 84}, w_{7, j + 84}$ from fixed-base multiplication circuit.
                \end{center}
            \item Variable-base scalar multiplication circuit for $T = k \cdot A$, where cells $w_{1, j + 254}, w_{2, j + 254}$ are copy constrained with $w_{3, j + 0}, w _{5, j + 0}$.
        \end{enumerate}
\end{enumerate}
It costs $3 + 2496 + 85 + 255 + 1 = 2840$ rows.
\subsection{Elliptic Curves Arithmetics}
\label{ellcurve}
\textbf{WIP}

This section instantiates the arithmetic of edwards25519 curve:
\begin{center}
    $- x^2 + y^2 = 1 - (121665/121666) \cdot x^2 \cdot y^2$
\end{center}
Affine coordinates are used for points.
Let $d$ be equal to $121665/121666$.

\paragraph{Fixed-base scalar multiplication circuit}:
We precompute all values $w(B,s',k) = k_i \cdot 8^{s'} B$, where $k_i \in \{ 0,..7 \}$, $s' \in \{0,.., 84\}$.
\begin{center}
    \begin{tabular}{ c|c|c|c|c|c|c|c|c|c }
        & $w_0$  & $w_1$  & $w_2$  & $w_3$  & $w_4$  & $w_5$ & $w_6$ & $w_7$ & $w_8$  \\
        \hline
        j + 0  & $acc$  & $b_{252}$ & $b_{251}$ & $b_{250}$ & $u_1$ & $v_1$ & $x_{acc}$ & $y_{acc}$ & $--$   \\
        j + 1  & $acc$  & $b_{249}$ & $b_{248}$ & $b_{247}$ & $u_1$ & $v_1$ & $x_{acc}$ & $y_{acc}$ & $--$   \\
        ...    &             &             &             &             &      & & & &  \\
        j + 84 & $s$  & $--$ & $--$ & $--$ & $--$ & $b_{0}$ & $x_{acc}$ & $y_{acc}$ & $--$   \\
    \end{tabular}
\end{center}
Evaluations:
\begin{center}
The values $b_i$, $i = 0,.., 252$ are binary representation of the scalar $s$ and $acc$ in each row is an accumulator for these bits.\\
$(u_1, v_1) = (b_{i + 2} \cdot 2^2 + b_{i + 1}\cdot 2 + b_i) \cdot B$ for each row.\\
 $(x_{acc_{j + 0}}, y_{acc_{j + 0}}) = (u_{1_{j + 0}}, v_{1_{j + 0}}) $ \\
 $(x_{acc_{j + k}}, y_{acc_{j + k}}) = (u_{1_{j + k}}, v_{1_{j + k}}) + (x_{acc_{j + k - 1}}, y_{acc_{j + k - 1}}) $ \\
\end{center}

Define the following functions:
\begin{enumerate}
    \item $\phi_1: (x_1, x_2, x_3, x_4) \mapsto $ \\
        $x_3 \cdot (-u'_0 \cdot x_2 \cdot x_1 + u'_0 \cdot x_1 + u'_0 \cdot x_2
        - u'_0 + u'_2 \cdot x_1 \cdot x_2 - u'_2\cdot x_2 + u'_4 \cdot x_1 \cdot x_2
        - u'_4\cdot x_2 -u'_6 \cdot x_1 \cdot x_2 + u'_1 \cdot x_2 \cdot x_1
        - u'_1 \cdot x_1 - u'_1 \cdot x_2 + u'_1  - u'_3 \cdot x_1 \cdot x_2 + u'_3\cdot x_2
        - u'_5 \cdot x_1 \cdot x_2 + u'_5\cdot x_2 + u'_7 \cdot x_1 \cdot x_2) -
        (x_4 - u'_0 \cdot x_2 \cdot x_1 + u'_0 \cdot x_1 + u'_0 \cdot x_2
        - u'_0 + u'_2 \cdot x_1 \cdot x_2 - u'_2\cdot x_2 + u'_4 \cdot x_1 \cdot x_2
        - u'_4\cdot x_2 -u'_6 \cdot x_1 \cdot x_2)$
    \item $\phi_2: (x_1, x_2, x_3, x_4) \mapsto $ \\
        $x_3 \cdot (-v'_0 \cdot x_2 \cdot x_1 + v'_0 \cdot x_1 + v'_0 \cdot x_2
        - v'_0 + v'_2 \cdot x_1 \cdot x_2 -v'_2 \cdot x_2 + v'_4 \cdot x_1 \cdot x_2
        - v'_4 \cdot x_2 - v'_6 \cdot x_1 \cdot x_2 + v'_1 \cdot x_2 \cdot x_1
        - v'_1 \cdot x_1 - v'_1 \cdot x_2 + v'_1  - v'_3 \cdot x_1 \cdot x_2
        + v'_3 \cdot x_2 - v'_5 \cdot x_1 \cdot x_2 + v'_5 \cdot x_2
        + v'_7 \cdot x_1 \cdot x_2) - (x_4 - v'_0 \cdot x_2 \cdot x_1
        + v'_0 \cdot x_1 + v'_0 \cdot x_2 - v'_0 + v'_2 \cdot x_1 \cdot x_2
        - v'_2 \cdot x_2 + v'_4 \cdot x_1 \cdot x_2 - v'_4 \cdot x_2 - v'_6 \cdot x_1 \cdot x_2) $
    \item $\phi_3: (x_1, x_3, x_4, x_5, x_6) \mapsto $ \\
        $x_1 \cdot (1 + d \cdot x_3 \cdot x_4 \cdot x_5 \cdot x_6)
        - (x_3 \cdot x_6 + x_4 \cdot x_5)$
    \item $\phi_4: (x_2, x_3, x_4, x_5, x_6) \mapsto $ \\
        $x_2 \cdot (1 - d \cdot x_3 \cdot x_4 \cdot x_5 \cdot x_6) - (x_3 \cdot x_5 + x_4 \cdot x_6)$
\end{enumerate}

Constraints:
\begin{itemize}
    \item For $j + 0$:
        \begin{itemize}
            \item $(w_{1, j + 0} - 1) \cdot w_{1, j + 0} = 0$ 
        	 \item $(w_{2, j + 0} - 1) \cdot w_{2, j + 0} = 0$
        	 \item $(w_{3, j + 0} - 1) \cdot w_{3, j + 0} = 0$ 
            \item $w_{0, j + 0} = w_{1, j + 0} \cdot 2^2 + w_{2, j + 0} \cdot 2 + w_{3, j + 0}$
            \item $\phi_1(w_{1, j + 0}, w_{2, j + 0}, w_{3, j + 0}, w_{4, j + 0}) = 0$, where $(u'_{i}, v'_{i}) = w(B, j + 0, i)$
            \item $\phi_2(w_{1, j + 0}, w_{2, j + 0}, w_{3, j + 0}, w_{5, j + 0}) = 0$, where $(u'_{i}, v'_{i}) = w(B, j + 0, i)$
            \item $w_{6, j + 0} = w_{4, j + 0}$
            \item $w_{7, j + 0} = w_{5, j + 0}$
        \end{itemize}
    \item For $j + z$, $z \neq 0$, $z \neq 84$:
        \begin{itemize}
            \item $(w_{1, j + z} - 1) \cdot w_{1, j + z} = 0$ 
        	 \item $(w_{2, j + z} - 1) \cdot w_{2, j + z} = 0$
        	 \item $(w_{3, j + z} - 1) \cdot w_{3, j + z} = 0$ 
            \item $w_{0, j + z} = w_{0, j + z - 1} \cdot 2^3 + w_{1, j + z} \cdot 2^2 + w_{2, j + z} \cdot 2 + w_{3, j + z}$
            \item $\phi_1(w_{1, j + z}, w_{2, j + z}, w_{3, j + z}, w_{4, j + z}) = 0$, where $(u'_{i}, v'_{i}) = w(B, j + z, i)$
            \item $\phi_2(w_{1, j + z}, w_{2, j + z}, w_{3, j + z}, w_{5, j + z }) = 0$, where $(u'_{i}, v'_{i}) = w(B, j + z, i)$
            \item $\phi_3(w_{6, j + z}, w_{6, j + z - 1}, w_{7, j + z - 1}, w_{4, j + z}, w_{5, j + z }) = 0$
            \item $\phi_4(w_{7, j + z}, w_{6, j + z - 1}, w_{7, j + z - 1}, w_{4, j + z}, w_{5, j + z }) = 0$
        \end{itemize}

    \item For $j + 84$:
        \begin{itemize}
        	 \item $(w_{5, j + 84} - 1) \cdot w_{5, j + 84} = 0$ 
            \item $w_{0, j + 84} = w_{0, j + 83} \cdot 2 + w_{5, j + 84}$
            \item $\phi_3(w_{6, j + z}, w_{6, j + z - 1}, w_{7, j + z - 1}, w_{5, j + 84} \cdot x_B, w_{5, j + 84} \cdot y_B + (1 - w_{5, j + 84}) ) = 0$
            \item $\phi_4(w_{7, j + z}, w_{6, j + z - 1}, w_{7, j + z - 1}, w_{5, j + 84} \cdot x_B, w_{5, j + 84} \cdot y_B + (1 - w_{5, j + 84}) ) = 0$, where $B = (x_B, y_B)$.
        \end{itemize}
\end{itemize}

\paragraph{Variable-base scalar multiplication circuit}:
\begin{center}
    \begin{tabular}{ c|c|c|c|c|c|c|c|c|c }
        & $w_0$  & $w_1$  & $w_2$  & $w_3$  & $w_4$  & $w_5$ & $w_6$ & $w_7$ & $w_8$  \\
        \hline
        j + 0  & $acc$  & $b_{511}$ & $b_{510}$ & $x_2$   & $y_2$ & $b_{509}$  & $x_3$ & $y_3$ & $b_{508}$    \\
        j + 1  & $acc$ & $x_1$  & $ y_1$  & $x_4$ & $ y_4$ & $b_{507}$  & $x_5$ & $y_5$ & $b_{506}$ \\
        j + 2  & $acc$  & $x_1$ & $y_1$  & $x_6$ & $y_6$ & $b_{505}$ & $x_7$ & $y_7$  & $b_{504}$  \\
        ...     &             &            &           &             &           \\
        j + 253  & $acc$ & $x_1$  & $ y_1$  & $x_{508}$ & $ y_{508}$ & $b_{3}$  & $x_{509}$ & $y_{509}$ & $b_{2}$ \\
        j + 254  & $k$ & $x_{512}$ & $y_{512}$ & $x_{510}$ & $y_{510}$ & $b_{1}$   & $x_{511}$ & $y_{511}$  & $b_{0}$    \\
    \end{tabular}
\end{center}
Evaluations:
\begin{center}
The values $b_i$, $i = 0,.., 511$ are binary representation of the scalar $k$ and $acc$ in each row is an accumulator for these bits.\\
 The values $(x_1, y_1) = A$.\\
 $(x_2, y_2) = 2 (b_{511} \cdot (x_1, y_1)) + b_{510} \cdot (x_1, y_1)$ \\
  $(x_i, y_i) = 2 (x_{i - 1}, y_{i - 1}) + b_{512 - i} \cdot (x_1, y_1)$ \\
\end{center}

Define the following functions:
\begin{enumerate}
    \item $\phi_1: (b, x_1, y_1, x_2, y_2, x_3) \mapsto $ \\
        $x_3 \cdot ((y_1^2 - x_1^2)\cdot(2 - y_1^2 + x_1^2) + 2dx_1y_1(y_1^2+x_1^2) \cdot x_2y_2b ) - (2x_1y_1\cdot(2 - y_1^2 +x_1^2)\cdot (y_2b + (1 - b)) + (y_1^2 + x_1^2)\cdot(y_1^2 - x_1^2)\cdot x_2 b)$

    \item $\phi_2: (b, x_1, y_1, x_2, y_2, y_3) \mapsto $ \\
        $y_3 \cdot ((y_1^2 - x_1^2)\cdot(2 - y_1^2 + x_1^2) - 2dx_1y_1(y_1^2+x_1^2) \cdot x_2y_2b ) - (2x_1y_1\cdot(2 - y_1^2 +x_1^2)\cdot x_2b + (y_1^2 + x_1^2)\cdot(y_1^2 - x_1^2)\cdot (y_2b + (1 - b)))$
\end{enumerate}

Constraints:
\begin{itemize}
    \item For $j + 0$:
        \begin{itemize}
        	 \item $(w_{1, j + 0} - 1) \cdot w_{1, j + 0} = 0$ 
        	 \item $(w_{2, j + 0} - 1) \cdot w_{2, j + 0} = 0$
        	 \item $(w_{5, j + 0} - 1) \cdot w_{5, j + 0} = 0$ 
        	 \item $(w_{8, j + 0} - 1) \cdot w_{8, j + 0} = 0$ 
            \item $w_{0, j + 0} = w_{1, j} \cdot 2^3 + w_{2, j + 0} \cdot 2^2 + w_{5, j + 0} \cdot 2 + w_{8, j + 0}$
            \item $\phi_1(w_{2, j + 0}, w_{1, j + 1} \cdot w_{1, j + 0}, (w_{2, j + 1} \cdot w_{1, j + 0} + (1 - w_{1, j + 0})), w_{1, j + 1}, w_{2, j + 1}, w_{3, j + 0})$
            \item $\phi_2(w_{2, j + 0}, w_{1, j + 1} \cdot w_{1, j + 0}, (w_{2, j + 1} \cdot w_{1, j + 0} + (1 - w_{1, j + 0})), w_{1, j + 1}, w_{2, j + 1}, w_{4, j + 0})$
            \item $\phi_1(w_{5, j + 0}, w_{3, j + 0}, (w_{4, j + 0}, w_{1, j + 1}, w_{2, j + 1}, w_{6, j + 0})$
            \item $\phi_2(w_{5, j + 0}, w_{3, j + 0}, (w_{4, j + 0}, w_{1, j + 1}, w_{2, j + 1}, w_{7, j + 0})$
        \end{itemize}
    \item For $j + z$, $z \equiv 1 \mod 2$:
        \begin{itemize}
        	\item $w_{1, j + z} = w_{1, j + z - 1}$
        	\item $w_{2, j + z} = w_{2, j + z - 1}$
        	 \item $(w_{5, j + z} - 1) \cdot w_{5, j + z} = 0$
        	 \item $(w_{8, j + z} - 1) \cdot w_{8, j + z} = 0$
            \item $w_{0, j + z} = w_{0, j + z - 1} \cdot 2^2 + w_{5, j + z} \cdot 2 + w_{8, j + z}$
            \item $\phi_1(w_{8, j + z - 1}, w_{6, j + z - 1}, w_{7, j + z - 1}, w_{1, j + z}, w_{2, j + z}, w_{3, j + z})$
            \item $\phi_2(w_{8, j + z - 1}, w_{6, j + z - 1}, w_{7, j + z - 1}, w_{1, j + z}, w_{2, j + z}, w_{4, j + z})$
            \item $\phi_1(w_{5, j + z}, w_{3, j + z}, w_{4, j + z}, w_{1, j + z}, w_{2, j + z}, w_{6, j + z})$
            \item $\phi_2(w_{5, j + z}, w_{3, j + z}, w_{4, j + z}, w_{1, j + z}, w_{2, j + z}, w_{7, j + z})$         
        \end{itemize}
    \item For $j + z$, $z \equiv 0 \mod 2, z \neq 0$:
        \begin{itemize}
        	\item $w_{1, j + z} = w_{1, j + z - 1}$
        	\item $w_{2, j + z} = w_{2, j + z - 1}$
            \item $(w_{5, j + z} - 1) \cdot w_{5, j + z} = 0$
        	 \item $(w_{8, j + z} - 1) \cdot w_{8, j + z} = 0$
            \item $w_{0, j + z} = w_{0, j + z - 1} \cdot 2^2 + w_{5, j + z} \cdot 2 + w_{8, j + z}$
            \item $\phi_1(w_{8, j + z - 1}, w_{6, j + z - 1}, w_{7, j + z - 1}, w_{1, j + z - 1}, w_{2, j + z - 1}, w_{3, j + z})$
            \item $\phi_2(w_{8, j + z - 1}, w_{6, j + z - 1}, w_{7, j + z - 1}, w_{1, j + z - 1}, w_{2, j + z - 1}, w_{4, j + z})$
            \item $\phi_1(w_{5, j + z}, w_{3, j + z}, w_{4, j + z}, w_{1, j + z - 1}, w_{2, j + z - 1}, w_{6, j + z})$
            \item $\phi_2(w_{5, j + z}, w_{3, j + z}, w_{4, j + z}, w_{1, j + z - 1}, w_{2, j + z - 1}, w_{7, j + z})$         
        \end{itemize}
    \item For $j + 254$:
        \begin{itemize}
        	 \item $(w_{5, j + z} - 1) \cdot w_{5, j + z} = 0$
        	 \item $(w_{8, j + z} - 1) \cdot w_{8, j + z} = 0$
            \item $w_{0, j + 254} = w_{0, j + 253} \cdot 2^2 + w_{5, j + 254} \cdot 2 + w_{8, j + 254}$
            \item $\phi_1(w_{8, j + 253}, w_{6, j + 253}, w_{7, j + 253}, w_{1, j + 253}, w_{2, j + 253}, w_{1, j + 254})$
            \item $\phi_2(w_{8, j + 253}, w_{6, j + 253}, w_{7, j + 253}, w_{1, j + 253}, w_{2, j + 253}, w_{4, j + 254})$
            \item $\phi_1(w_{5, j + 254}, w_{3, j + 254}, w_{4, j + 254}, w_{1, j + 253}, w_{2, j + 253}, w_{6, j + 254})$
            \item $\phi_2(w_{5, j + 254}, w_{3, j + 254}, w_{4, j + 254}, w_{1, j + 253}, w_{2, j + 253}, w_{7, j + 254})$
            \item $\phi_1(w_{8, j + 254}, w_{6, j + 254}, w_{7, j + 254}, w_{1, j + 253}, w_{2, j + 253}, w_{1, j + 254})$
            \item $\phi_2(w_{8, j + 254}, w_{6, j + 254}, w_{7, j + 254}, w_{1, j + 253}, w_{2, j + 253}, w_{2, j + 254})$ 
        \end{itemize}

\end{itemize}
