\subsection{Ed25519 Circuit}
\label{section:eddsa}

To verify a signature $(R,s)$ on a message $M$ using public key $A$ and a generator $B$ do:
\begin{enumerate}
    \item Prove that $s$ in the range $L = 2^{252}+27742317777372353535851937790883648493$.
        \begin{center}
    \begin{tabular}{ c|c|c|c|c|c|c|c|c|c }
        & $w_1$  & $w_2$  & $w_3$  & $w_4$  & $w_5$  & $w_6$ & $w_7$ & $w_8$ & $w_9$  \\
            \hline
                j + 0 & $s$ & $z_0$ & $z_1$ & $z_2$ & $z_3$ & $z_4$ & $z_5$ & $z_6$ & $z_7$ \\
                j + 1 & $z_8$ & $z_{9}$ & $z_{10}$ & $z_{11}$ & $z_{12}$ & $z_{13}$ & $z_{14}$ & $z_{15}$ & $z_{16}$ \\
                j + 2 & $z_{17}$ & $z_{18}$ & $z_{19}$ & $z_{20}$ & $z_{21}$ & $z_{22}$ & $z_{23}$ & $z_{24}$ & $z_{25}$ \\
            \end{tabular}
        \end{center}
        Constraints:
        \begin{center}
            $w_{2, j} = w_{1,j} + 2^{253} - L $ \\
            Each $w_{i,k} - 2^{10} \cdot w_{i + a, k + b} $, where $i = 2,..,9$ for $k = 0$, $i = 1,..,9$ for $k = 1$ and $i = 1,..,8$ for $k = 2$, $(i + 1) = b \cdot 9 + a$  is range-constrained by 10-bits plookup table. \\
            $w_{9,j+2} \cdot 2^7 $ is range-constrained by 10-bits plookup table.
        \end{center}
	It costs $3$ rows.
    \item $k ==$ SHA-512$(data||R||A||M)$ // See section \ref{sha512}
    It costs $1248 \cdot 2 = 2496$ rows.
    \item $sB ?=? R + kA$:
        \begin{enumerate}
            \item Fixed-base scalar multiplication circuit is used for $sB = S$. The cell $w_{1, j + 84}$ is copy-constrained with $w_{1, j + 0}$ from the range circuit.
            \item One addition is used for $S + (-R)$. The coordinates of $R$ and $T = S + (-R)$ are placed on the last row of fixed-base scalar multiplication circuit.
                In total, three constraints are used for addition:
                \begin{center}
                    $w_{4, j + 84}\cdot (1 + d w_{7, j + 84} \cdot (-w_{2, j + 84}) \cdot w_{8, j + 84} \cdot w_{3, j + 84}) = w_{7, j + 84} \cdot w_{3, j + 84} + (-w_{2, j + 84}) \cdot w_{8, j + 84}$ \\
                    $w_{5, j + 84} \cdot (1 - d w_{7, j + 84} \cdot (-w_{2, j + 84}) \cdot w_{8, j + 84} \cdot w_{3, j + 84}) = w_{7, j + 84} \cdot (-w_{2, j + 84}) + w_{3, j + 84} \cdot w_{8, j + 84}$ \\
                    $(- w_{2, j + 84})^2 + w_{3, j + 84}^2 = 1 - d \cdot w_{2, j + 84}^2 \cdot w_{3, j + 84}^2$
                \end{center}
            \item Variable-base scalar multiplication circuit for $T = k \cdot A$, where cells $w_{2, j + 254}, w_{3, j + 254}$ are copy constrained with $w_{4, j + 84}, w _{5, j + 84}$ from the fixed-base scalar multiplication circuit.
        \end{enumerate}
\end{enumerate}
It costs $3 + 2496 + 85 + 255 = 2839$ rows.
\subsection{Elliptic Curves Arithmetics}
\label{ellcurve}
\textbf{WIP}

This section instantiates the arithmetic of edwards25519 curve:
\begin{center}
    $- x^2 + y^2 = 1 - (121665/121666) \cdot x^2 \cdot y^2$
\end{center}
Affine coordinates are used for points.
Let $d$ be equal to $121665/121666$.

\paragraph{Fixed-base scalar multiplication circuit}:
We precompute all values $w(B,s,k) = k_i \cdot 8^s B$, where $k_i \in \{ 0,..7 \}$, $s \in \{0,.., 84\}$.
\begin{center}
    \begin{tabular}{ c|c|c|c|c|c|c|c|c|c }
        & $w_1$  & $w_2$  & $w_3$  & $w_4$  & $w_5$  & $w_6$ & $w_7$ & $w_8$ & $w_9$  \\
        \hline
        j + 0  & $acc$  & $b_{252}$ & $b_{251}$ & $b_{250}$ & $u_1$ & $v_1$ & $x_{acc}$ & $y_{acc}$ & $--$   \\
        j + 1  & $acc$  & $b_{249}$ & $b_{248}$ & $b_{247}$ & $u_1$ & $v_1$ & $x_{acc}$ & $y_{acc}$ & $--$   \\
        ...    &             &             &             &             &      & & & &  \\
        j + 84 & $s$  & $x_r$ & $y_r$ & $x_t$ & $y_t$ & $b_{0}$ & $x_{acc}$ & $y_{acc}$ & $--$   \\
    \end{tabular}
\end{center}

Define the following functions:
\begin{enumerate}
    \item $\phi_1: (x_1, x_2, x_3, x_4) \mapsto $ \\
        $x_3 \cdot (-u'_0 \cdot x_2 \cdot x_1 + u'_0 \cdot x_1 + u'_0 \cdot x_2
        - u'_0 + u'_2 \cdot x_1 \cdot x_2 - u'_2\cdot x_2 + u'_4 \cdot x_1 \cdot x_2
        - u'_4\cdot x_2 -u'_6 \cdot x_1 \cdot x_2 + u'_1 \cdot x_2 \cdot x_1
        - u'_1 \cdot x_1 - u'_1 \cdot x_2 + u'_1  - u'_3 \cdot x_1 \cdot x_2 + u'_3\cdot x_2
        - u'_5 \cdot x_1 \cdot x_2 + u'_5\cdot x_2 + u'_7 \cdot x_1 \cdot x_2) -
        (x_4 - u'_0 \cdot x_2 \cdot x_1 + u'_0 \cdot x_1 + u'_0 \cdot x_2
        - u'_0 + u'_2 \cdot x_1 \cdot x_2 - u'_2\cdot x_2 + u'_4 \cdot x_1 \cdot x_2
        - u'_4\cdot x_2 -u'_6 \cdot x_1 \cdot x_2)$
    \item $\phi_2: (x_1, x_2, x_3, x_4) \mapsto $ \\
        $x_3 \cdot (-v'_0 \cdot x_2 \cdot x_1 + v'_0 \cdot x_1 + v'_0 \cdot x_2
        - v'_0 + v'_2 \cdot x_1 \cdot x_2 -v'_2 \cdot x_2 + v'_4 \cdot x_1 \cdot x_2
        - v'_4 \cdot x_2 - v'_6 \cdot x_1 \cdot x_2 + v'_1 \cdot x_2 \cdot x_1
        - v'_1 \cdot x_1 - v'_1 \cdot x_2 + v'_1  - v'_3 \cdot x_1 \cdot x_2
        + v'_3 \cdot x_2 - v'_5 \cdot x_1 \cdot x_2 + v'_5 \cdot x_2
        + v'_7 \cdot x_1 \cdot x_2) - (x_4 - v'_0 \cdot x_2 \cdot x_1
        + v'_0 \cdot x_1 + v'_0 \cdot x_2 - v'_0 + v'_2 \cdot x_1 \cdot x_2
        - v'_2 \cdot x_2 + v'_4 \cdot x_1 \cdot x_2 - v'_4 \cdot x_2 - v'_6 \cdot x_1 \cdot x_2) $
    \item $\phi_3: (x_1, x_3, x_4, x_5, x_6) \mapsto $ \\
        $x_1 \cdot (1 + d \cdot x_3 \cdot x_4 \cdot x_5 \cdot x_6)
        - (x_3 \cdot x_6 + x_4 \cdot x_5)$
    \item $\phi_4: (x_2, x_3, x_4, x_5, x_6) \mapsto $ \\
        $x_2 \cdot (1 - d \cdot x_3 \cdot x_4 \cdot x_5 \cdot x_6) - (x_3 \cdot x_5 + x_4 \cdot x_6)$
\end{enumerate}

Constraints:
\begin{itemize}
    \item For $j + 0$:
        \begin{itemize}
            \item $(w_{2, j + 0} - 1) \cdot w_{2, j + 0} = 0$ 
        	 \item $(w_{3, j + 0} - 1) \cdot w_{3, j + 0} = 0$
        	 \item $(w_{4, j + 0} - 1) \cdot w_{4, j + 0} = 0$ 
            \item $w_{1, j + 0} = w_{2, j + 0} \cdot 2^2 + w_{3, j + 0} \cdot 2 + w_{4, j + 0}$
            \item $\phi_1(w_{2, j + 0}, w_{3, j + 0}, w_{4, j + 0}, w_{5, j + 0}) = 0$, where $(u'_{i}, v'_{i}) = w(B, j + 0, i)$
            \item $\phi_2(w_{2, j + 0}, w_{3, j + 0}, w_{4, j + 0}, w_{6, j + 0}) = 0$, where $(u'_{i}, v'_{i}) = w(B, j + 0, i)$
            \item $w_{7, j + 0} = w_{5, j + 0}$
            \item $w_{8, j + 0} = w_{6, j + 0}$
        \end{itemize}
    \item For $j + z$, $z \neq 0$, $z \neq 84$:
        \begin{itemize}
            \item $(w_{2, j + z} - 1) \cdot w_{2, j + z} = 0$ 
        	 \item $(w_{3, j + z} - 1) \cdot w_{3, j + z} = 0$
        	 \item $(w_{4, j + z} - 1) \cdot w_{4, j + z} = 0$ 
            \item $w_{1, j + z} = w_{1, j + z - 1} \cdot 2^3 + w_{2, j + z} \cdot 2^2 + w_{3, j + z} \cdot 2 + w_{4, j + z}$
            \item $\phi_1(w_{2, j + z}, w_{3, j + z}, w_{4, j + z}, w_{5, j + z}) = 0$, where $(u'_{i}, v'_{i}) = w(B, j + z, i)$
            \item $\phi_2(w_{2, j + z}, w_{3, j + z}, w_{4, j + z}, w_{6, j + z }) = 0$, where $(u'_{i}, v'_{i}) = w(B, j + z, i)$
            \item $\phi_3(w_{7, j + z}, w_{7, j + z - 1}, w_{8, j + z - 1}, w_{5, j + z}, w_{6, j + z }) = 0$
            \item $\phi_4(w_{8, j + z}, w_{7, j + z - 1}, w_{8, j + z - 1}, w_{5, j + z}, w_{6, j + z }) = 0$
        \end{itemize}

    \item For $j + 84$:
        \begin{itemize}
        	 \item $(w_{6, j + 84} - 1) \cdot w_{6, j + 84} = 0$ 
            \item $w_{1, j + 84} = w_{1, j + 83} \cdot 2 + w_{6, j + 84}$
            \item $\phi_3(w_{7, j + z}, w_{7, j + z - 1}, w_{8, j + z - 1}, w_{6, j + 84} \cdot x_B, w_{6, j + 84} \cdot y_B + (1 - w_{6, j + 84}) ) = 0$
            \item $\phi_4(w_{8, j + z}, w_{7, j + z - 1}, w_{8, j + z - 1}, w_{6, j + 84} \cdot x_B, w_{6, j + 84} \cdot y_B + (1 - w_{6, j + 84}) ) = 0$, where $B = (x_B, y_B)$.
        \end{itemize}
\end{itemize}

\paragraph{Variable-base scalar multiplication circuit}:
\begin{center}
    \begin{tabular}{ c|c|c|c|c|c|c|c|c|c }
        & $w_1$  & $w_2$  & $w_3$  & $w_4$  & $w_5$  & $w_6$ & $w_7$ & $w_8$ & $w_9$  \\
        \hline
        j + 0  & $acc$  & $b_{511}$ & $b_{510}$ & $x_2$   & $y_2$ & $b_{509}$  & $x_3$ & $y_3$ & $b_{508}$    \\
        j + 1  & $acc$ & $x_1$  & $ y_1$  & $x_4$ & $ y_4$ & $b_{507}$  & $x_5$ & $y_5$ & $b_{506}$ \\
        j + 2  & $acc$  & $--$ & $--$  & $x_6$ & $y_6$ & $b_{505}$ & $x_7$ & $y_7$  & $b_{504}$  \\
        ...     &             &            &           &             &           \\
        j + 253  & $acc$ & $x_1$  & $ y_1$  & $x_4$ & $ y_4$ & $b_{3}$  & $x_3$ & $y_3$ & $b_{2}$ \\
        j + 254  & $k$ & $x_0$ & $y_0$ & $x_2$ & $y_2$ & $b_{1}$   & $x_1$ & $y_1$  & $b_{0}$    \\
    \end{tabular}
\end{center}

Define the following functions:
\begin{enumerate}
    \item $\phi_1: (b, x_1, y_1, x_2, y_2, x_3) \mapsto $ \\
        $x_3 \cdot ((y_1^2 - x_1^2)\cdot(2 - y_1^2 + x_1^2) + 2dx_1y_1(y_1^2+x_1^2) \cdot x_2y_2b ) - (2x_1y_1\cdot(2 - y_1^2 +x_1^2)\cdot (y_2b + (1 - b)) + (y_1^2 + x_1^2)\cdot(y_1^2 - x_1^2)\cdot x_2 b)$

    \item $\phi_2: (b, x_1, y_1, x_2, y_2, y_3) \mapsto $ \\
        $y_3 \cdot ((y_1^2 - x_1^2)\cdot(2 - y_1^2 + x_1^2) - 2dx_1y_1(y_1^2+x_1^2) \cdot x_2y_2b ) - (2x_1y_1\cdot(2 - y_1^2 +x_1^2)\cdot x_2b + (y_1^2 + x_1^2)\cdot(y_1^2 - x_1^2)\cdot (y_2b + (1 - b)))$
\end{enumerate}

Constraints:
\begin{itemize}
    \item For $j + 0$:
        \begin{itemize}
        	 \item $(w_{2, j + 0} - 1) \cdot w_{2, j + 0} = 0$ 
        	 \item $(w_{3, j + 0} - 1) \cdot w_{3, j + 0} = 0$
        	 \item $(w_{6, j + 0} - 1) \cdot w_{6, j + 0} = 0$ 
        	 \item $(w_{9, j + 0} - 1) \cdot w_{9, j + 0} = 0$ 
            \item $w_{1, j + 0} = w_{2, j} \cdot 2^3 + w_{3, j + 0} \cdot 2^2 + w_{6, j + 0} \cdot 2 + w_{9, j + 0}$
            \item $\phi_1(w_{3, j + 0}, w_{2, j + 1} \cdot w_{2, j + 0}, (w_{3, j + 1} \cdot w_{2, j + 0} + (1 - w_{2, j + 0})), w_{2, j + 1}, w_{3, j + 1}, w_{4, j + 0})$
            \item $\phi_2(w_{3, j + 0}, w_{2, j + 1} \cdot w_{2, j + 0}, (w_{3, j + 1} \cdot w_{2, j + 0} + (1 - w_{2, j + 0})), w_{2, j + 1}, w_{3, j + 1}, w_{5, j + 0})$
            \item $\phi_1(w_{6, j + 0}, w_{4, j + 0}, (w_{5, j + 0}, w_{2, j + 1}, w_{3, j + 1}, w_{7, j + 0})$
            \item $\phi_2(w_{6, j + 0}, w_{4, j + 0}, (w_{5, j + 0}, w_{2, j + 1}, w_{3, j + 1}, w_{8, j + 0})$
        \end{itemize}
    \item For $j + z$, $z \equiv 1 \mod 2$:
        \begin{itemize}
        	 \item $(w_{6, j + z} - 1) \cdot w_{6, j + z} = 0$
        	 \item $(w_{9, j + z} - 1) \cdot w_{9, j + z} = 0$
            \item $w_{1, j + z} = w_{1, j + z - 1} \cdot 2^2 + w_{6, j + z} \cdot 2 + w_{9, j + z}$
            \item $\phi_1(w_{9, j + z - 1}, w_{7, j + z - 1}, w_{8, j + z - 1}, w_{2, j + z}, w_{3, j + z}, w_{4, j + z})$
            \item $\phi_2(w_{9, j + z - 1}, w_{7, j + z - 1}, w_{8, j + z - 1}, w_{2, j + z}, w_{3, j + z}, w_{5, j + z})$
            \item $\phi_1(w_{6, j + z}, w_{4, j + z}, w_{5, j + z}, w_{2, j + z}, w_{3, j + z}, w_{7, j + z})$
            \item $\phi_2(w_{6, j + z}, w_{4, j + z}, w_{5, j + z}, w_{2, j + z}, w_{3, j + z}, w_{8, j + z})$         
        \end{itemize}
    \item For $j + z$, $z \equiv 0 \mod 2, z \neq 0$:
        \begin{itemize}
            \item $(w_{6, j + z} - 1) \cdot w_{6, j + z} = 0$
        	 \item $(w_{9, j + z} - 1) \cdot w_{9, j + z} = 0$
            \item $w_{1, j + z} = w_{1, j + z - 1} \cdot 2^2 + w_{6, j + z} \cdot 2 + w_{9, j + z}$
            \item $\phi_1(w_{9, j + z - 1}, w_{7, j + z - 1}, w_{8, j + z - 1}, w_{2, j + z - 1}, w_{3, j + z - 1}, w_{4, j + z})$
            \item $\phi_2(w_{9, j + z - 1}, w_{7, j + z - 1}, w_{8, j + z - 1}, w_{2, j + z - 1}, w_{3, j + z - 1}, w_{5, j + z})$
            \item $\phi_1(w_{6, j + z}, w_{4, j + z}, w_{5, j + z}, w_{2, j + z - 1}, w_{3, j + z - 1}, w_{7, j + z})$
            \item $\phi_2(w_{6, j + z}, w_{4, j + z}, w_{5, j + z}, w_{2, j + z - 1}, w_{3, j + z - 1}, w_{8, j + z})$         
        \end{itemize}
    \item For $j + 254$:
        \begin{itemize}
        	 \item $(w_{6, j + z} - 1) \cdot w_{6, j + z} = 0$
        	 \item $(w_{9, j + z} - 1) \cdot w_{9, j + z} = 0$
            \item $w_{1, j + 254} = w_{1, j + 253} \cdot 2^2 + w_{6, j + 254} \cdot 2 + w_{9, j + 254}$
            \item $\phi_1(w_{9, j + 253}, w_{7, j + 253}, w_{8, j + 253}, w_{2, j + 253}, w_{3, j + 253}, w_{2, j + 254})$
            \item $\phi_2(w_{9, j + 253}, w_{7, j + 253}, w_{8, j + 253}, w_{2, j + 253}, w_{3, j + 253}, w_{5, j + 254})$
            \item $\phi_1(w_{6, j + 254}, w_{4, j + 254}, w_{5, j + 254}, w_{2, j + 253}, w_{3, j + 253}, w_{7, j + 254})$
            \item $\phi_2(w_{6, j + 254}, w_{4, j + 254}, w_{5, j + 254}, w_{2, j + 253}, w_{3, j + 253}, w_{8, j + 254})$
            \item $\phi_1(w_{9, j + 254}, w_{7, j + 254}, w_{8, j + 254}, w_{2, j + 253}, w_{3, j + 253}, w_{2, j + 254})$
            \item $\phi_2(w_{9, j + 254}, w_{7, j + 254}, w_{8, j + 254}, w_{2, j + 253}, w_{3, j + 253}, w_{3, j + 254})$ 
        \end{itemize}

\end{itemize}
